# Copyright 2025 Beijing Volcano Engine Technology Co., Ltd. and/or its affiliates
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This configuration is aligned with charts/veaiops/templates/frontend/configmap.yaml
# to ensure consistency between K8s deployment and standalone Docker container

map $uri $is_static_resource {
    default 0;
    ~*\.(css|js|json|map|woff|woff2|ttf|eot|otf|jpg|jpeg|png|gif|ico|svg|webp)$ 1;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    root /var/www;
    index index.html index.htm;

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;

    location ~ ^/.*/static/(.*)$ {
        alias /var/www/static/$1;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~ ^/.*/([^/]+\.(ico|svg|png|jpg|jpeg|gif|webmanifest))$ {
        try_files /$1 =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Document static resources - /veaiops/_nuxt/ directory (Nuxt.js build artifacts, baseURL=/veaiops/)
    # Priority: ^~ prefix matching, stops regex matching
    # ✅ Fix: Nuxt.js generates resource paths as /veaiops/_nuxt/, needs to map to actual file location
    location ^~ /veaiops/_nuxt/ {
        alias /var/www/help/veaiops/_nuxt/;
        include /etc/nginx/mime.types;
        default_type application/javascript;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Matched-Location "veaiops-nuxt" always;
        try_files $uri =404;
        access_log off;
    }

    # Document static resources - /veaiops/_payload.json and /veaiops/_nuxt/builds/ etc.
    # ✅ Fix: Handle other Nuxt.js resource paths
    location ^~ /veaiops/_payload.json {
        alias /var/www/help/veaiops/_payload.json;
        include /etc/nginx/mime.types;
        default_type application/json;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Matched-Location "veaiops-payload" always;
        try_files $uri =404;
        access_log off;
    }

    location ^~ /veaiops/_nuxt/builds/ {
        alias /var/www/help/veaiops/_nuxt/builds/;
        include /etc/nginx/mime.types;
        default_type application/json;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Matched-Location "veaiops-nuxt-builds" always;
        try_files $uri =404;
        access_log off;
    }

    # Document static resources - static files under /veaiops/ (js, css, images, etc., baseURL=/veaiops/)
    # Priority: regex matching, matches before document main location
    # ✅ Fix: Nuxt.js generates resource paths as /veaiops/, needs to map to actual file location
    # Note: Cannot use alias directly in regex matching, need to use rewrite + root or use root directly
    location ~ ^/veaiops/(.*\.(js|css|json|map|woff|woff2|ttf|eot|otf|jpg|jpeg|png|gif|ico|svg|webp))$ {
        root /var/www/help;
        include /etc/nginx/mime.types;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Matched-Location "veaiops-static-resources" always;
        try_files /veaiops/$1 =404;
        access_log off;
    }

    # Document static resources - /help/veaiops/_nuxt/ directory (fallback path)
    # Priority: ^~ prefix matching, stops regex matching
    location ^~ /help/veaiops/_nuxt/ {
        alias /var/www/help/veaiops/_nuxt/;
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Matched-Location "help-veaiops-nuxt" always;
        try_files $uri =404;
        access_log off;
    }

    # Document static resources - static files under /help/veaiops/ (js, css, images, etc.)
    # Priority: regex matching, matches before document main location
    location ~ ^/help/veaiops/.*\.(js|css|json|map|woff|woff2|ttf|eot|otf|jpg|jpeg|png|gif|ico|svg|webp)$ {
        root /var/www;
        include /etc/nginx/mime.types;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        add_header X-Matched-Location "help-veaiops-static-resources" always;
        try_files $uri =404;
        access_log off;
    }

    # Document main path - /help/veaiops/
    # Priority: ^~ prefix matching, stops regex matching
    # ✅ Fix: Use alias instead of root, fix try_files configuration
    location ^~ /help/veaiops/ {
        alias /var/www/help/veaiops/;
        include /etc/nginx/mime.types;
        add_header X-Matched-Location "help-veaiops" always;
        index index.html;
        # ✅ Fixed try_files:
        # 1. Try to access file path $uri
        # 2. Try to access as directory $uri/
        # 3. Try index.html under directory $uri/index.html
        # 4. If none exists, fallback to root index.html
        # 5. If still not found, return 404
        try_files $uri $uri/ $uri/index.html index.html =404;
        add_header Cache-Control "no-cache" always;
    }

    location /help/ {
        alias /var/www/help/;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
        try_files $uri $uri/ =404;
    }

    location / {
        try_files $uri $uri/ /index.html;
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
    }

    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
